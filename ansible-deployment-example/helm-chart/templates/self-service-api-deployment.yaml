{{- /* 1. Scope Variables: Define shared self-service-api context */ -}}
{{- $comp := dict "context" . "component" "self-service-api" -}}
{{- $name := include "cloud-self-service.componentName" $comp -}}
{{- $labels := include "cloud-self-service.labels" $comp -}}
{{- $selectors := include "cloud-self-service.selectorLabels" $comp -}}

{{- /* 2. Resource Name Lookups */ -}}
{{- $scriptConfigName := include "cloud-self-service.resourceName" (dict "context" . "component" "self-service-api" "name" "script-provider") -}}
{{- $tlsSecretName := include "cloud-self-service.resourceName" (dict "context" . "component" "self-service-api" "name" "tls") -}}

{{- /* 3. Database Connection Logic */ -}}
{{- $pgComp := dict "context" . "component" "postgres" -}}
{{- $pgBaseName := include "cloud-self-service.componentName" $pgComp -}}
{{- $pgHost := printf "%s-rw" $pgBaseName -}}
{{- $pgUser := .Values.selfServiceAPI.database.username -}}
{{- $pgPass := .Values.selfServiceAPI.database.password -}}
{{- $pgDB := .Values.selfServiceAPI.database.name -}}
{{- $defaultConn := printf "host=%s user=%s password=%s dbname=%s port=5432 sslmode=disable" $pgHost $pgUser $pgPass $pgDB -}}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $name }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- include "cloud-self-service.rolloutAnnotations" . | nindent 4 }}
    keel.sh/policy: all
    keel.sh/trigger: poll
    keel.sh/pollSchedule: "@every 60m"
  labels:
    {{- $labels | nindent 4 }}
spec:
  replicas: {{ .Values.selfServiceAPI.replicas }}
  selector:
    matchLabels:
      {{- $selectors | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- include "cloud-self-service.rolloutAnnotations" . | nindent 8 }}
      labels:
        {{- $selectors | nindent 8 }}
    spec:
      containers:
        - name: self-service-api
          image: {{ .Values.selfServiceAPI.image }}:{{ .Values.selfServiceAPI.version }}
          imagePullPolicy: {{ .Values.selfServiceAPI.imagePullPolicy | default "Always" }}
          ports:
            - containerPort: 8083
          env:
            # API Mode
            - name: API_MODE
              value: {{ .Values.selfServiceAPI.apiMode | quote }}
            # DNS Policy Configuration
            - name: DNS_POLICY_SUPERADMIN_EMAILS
              value: {{ .Values.selfServiceAPI.dnsPolicy.superAdminEmails | quote }}
            - name: DNS_POLICY_WEBHOOK_API_KEY
              value: {{ .Values.selfServiceAPI.dnsPolicy.webhookApiKey | quote }}
            # Auth Configuration
            {{- if eq .Values.auth.provider "oidc" }}
            - name: API_AUTH_PROVIDER
              value: "oidc"
            - name: OIDC_ISSUER_URL
              value: {{ .Values.auth.oidc.issuerUrl | quote }}
            - name: OIDC_CLIENT_ID
              value: {{ .Values.auth.oidc.clientId | quote }}
            {{- end }}
            # Database Connection
            - name: DB_TYPE
              value: {{ .Values.selfServiceAPI.database.type | quote }}
            - name: DB_CONNECTION_STRING
              value: {{ default $defaultConn .Values.selfServiceAPI.database.connectionString | quote }}


apiVersion: v1
kind: Service
metadata:
  name: {{ $name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
spec:
  selector:
    {{- $selectors | nindent 4 }}
  ports:
    - protocol: TCP
      port: 8083
      targetPort: 8083

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $name }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- range $key, $value := .Values.ingress.annotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  rules:
    - host: {{ .Values.selfServiceAPI.hostname | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $name }}
                port:
                  number: 8083
  tls:
    - hosts:
        - {{ .Values.selfServiceAPI.hostname | quote }}
      secretName: {{ $tlsSecretName }}
