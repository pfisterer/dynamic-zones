all:
    hosts:
        "141.1.2.3":
            ip_family: ipv4
            ansible_user: root

            dynamic_zones_version: 0.1.4-alpha
            app_hostname: dyndns.xxx.cloud
            cert_manager_email: xxx.yyy@zzz.de
            #external_dns_image_version: ""

            api_mode: development
            api_token_ttl_hours: 8760 # 1 year
            api_auth_provider: oidc
            oidc_issuer_url: https://sso.xxx.cloud/realms/yyy
            oidc_client_id: xxx-cloud-dns

            powerdns_url: "http://powerdns-api:8080"
            powerdns_server_ip: "141.72.5.244"
            powerdns_server_port: 53
            powerdns_vhost: localhost
            powerdns_api_key: my-api-key

            database_type: "postgres"
            pg_password_root: xxx
            pg_password_dynamic_zones: xxx
            database_connection_string: "host=postgresdb-rw user=dynamic_zones password={{ pg_password_dynamic_zones }} dbname=dynamic_zones port=5432 sslmode=disable"

            upstream_dns_server: xxx.yyy.de.
            upstream_dns_tsig_name: cloud-ns.xxx.de
            upstream_dns_tsig_alg: hmac-sha256
            upstream_dns_tsig_secret: some-base64-secret
            upstream_dns_zone: cloud-ns.yyy.xxx.de.
            upstream_dns_name: ns

            zone_provider_default_admin_tsig_name: dynamic-dns-admin-key
            zone_provider_default_admin_tsig_key: some-base64-secret
            zone_provider_default_admin_tsig_alg: HMAC-SHA512
            zone_provider_default_records: "[]"

            # Select zone provider to use
            zone_provider_type: script

            # Only used if zone_provider_type == fixed
            zone_provider_fixed_domain_suffixes: users.xxx.cloud
            zone_provider_fixed_domain_soa: users.xxx.cloud

            # Only used if zone_provider_type == script
            zone_provider_script_script: |
                function getUserZones(user) {
                    if (!user || !user.email) {
                        console.warn("getUserZones called with missing user or email.");
                        return [];
                    }

                    const email = user.email.toLowerCase();
                    const dhbwRegExp = /@dhbw(-.*)?.de$/i; 

                    let allowedZones = [{ zone: "no-valid-zone-available.example.com", 
                                          zone_soa: "no-valid-zone-available.example.com" }];

                    // User is part of a DHBW domain
                    if (dhbwRegExp.test(email)) {
                        const zone = makeDnsCompliantGo(email) + ".users.dhbw.cloud"
                        allowedZones = [{ zone: zone, zone_soa: zone }];
                    }

                    console.log(`User ${email} allowed zones:`, allowedZones);
                    return allowedZones;
                }

                function isAllowedZone(user, zone) {
                    const allowedZones = getUserZones(user);
                    const firstMatch = allowedZones.find(zr => zr.zone === zone);

                    const retValue = {
                        isAllowed: firstMatch != undefined,
                        errorMessage: "",
                        zoneResponse: firstMatch || {}
                    }

                    console.log(`isAllowedZone for user ${user.email} and zone ${zone}:`, retValue);
                    return retValue;
                }
