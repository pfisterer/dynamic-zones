{{- /* 1. Scope Variables: Define shared dynamic-zones context */ -}}
{{- $comp := dict "context" . "component" "dynamic-zones" -}}
{{- $name := include "cloud-self-service.componentName" $comp -}}
{{- $labels := include "cloud-self-service.labels" $comp -}}
{{- $selectors := include "cloud-self-service.selectorLabels" $comp -}}

{{- /* 2. Resource Name Lookups */ -}}
{{- $initialDataScriptName := include "cloud-self-service.resourceName" (dict "context" . "component" "dynamic-zones" "name" "initial-data-script-provider") -}}
{{- $tlsSecretName := include "cloud-self-service.resourceName" (dict "context" . "component" "dynamic-zones" "name" "tls") -}}
{{- $pdnsSvcName := include "cloud-self-service.resourceName" (dict "context" . "component" "powerdns" "name" "api") -}}

{{- /* 3. Database Connection Logic */ -}}
{{- $pgComp := dict "context" . "component" "postgres" -}}
{{- $pgBaseName := include "cloud-self-service.componentName" $pgComp -}}
{{- $pgHost := printf "%s-rw" $pgBaseName -}}
{{- $pgUser := .Values.dynamicZonesAPI.database.username -}}
{{- $pgPass := .Values.dynamicZonesAPI.database.password -}}
{{- $pgDB := .Values.dynamicZonesAPI.database.name -}}
{{- $defaultConn := printf "host=%s user=%s password=%s dbname=%s port=5432 sslmode=disable" $pgHost $pgUser $pgPass $pgDB -}}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $name }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- include "cloud-self-service.rolloutAnnotations" . | nindent 4 }}
    keel.sh/policy: all
    keel.sh/trigger: poll
    keel.sh/pollSchedule: "@every 60m"
  labels:
    {{ $labels | nindent 4 }}
spec:
  replicas: {{ .Values.dynamicZonesAPI.replicas }}
  selector:
    matchLabels:
      {{- $selectors | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- include "cloud-self-service.rolloutAnnotations" . | nindent 8 }}
      labels:
        {{- $selectors | nindent 8 }}
    spec:
      {{- if ne .Values.dynamicZonesAPI.initialDataProviderScript "" }}
      volumes:
        - name: script-provider
          configMap:
            name: {{ $initialDataScriptName }}
      {{- end }}
      containers:
        - name: dynamic-zones
          image: {{ .Values.dynamicZonesAPI.image }}:{{ .Values.dynamicZonesAPI.version }}
          imagePullPolicy: {{ .Values.dynamicZonesAPI.imagePullPolicy | default "Always" }}
          ports:
            - containerPort: 8082
          {{- if ne .Values.dynamicZonesAPI.initialDataProviderScript "" }}
          volumeMounts:
            - name: script-provider
              mountPath: /app/initial-data-script.js
              subPath: initial-data-script.js
          {{- end }}
          env:
            # General Settings
            {{- if .Values.dynamicZonesAPI.apiMode }}
            - name: API_MODE
              value: {{ .Values.dynamicZonesAPI.apiMode | quote }}
            {{- end }}

            - name: API_BASE_URL
              value: {{ printf "https://%s" .Values.dynamicZonesAPI.hostname | quote }}
            - name: API_TOKEN_TTL_HOURS
              value: {{ .Values.dynamicZonesAPI.apiTokenTtlHours | default "24" | quote }}

            # DNS Policy Settings
            {{- if .Values.dynamicZonesAPI.dnsPolicy.superAdminEmails }}
            - name: DNS_POLICY_SUPERADMIN_EMAILS
              value: {{ join "," .Values.dynamicZonesAPI.dnsPolicy.superAdminEmails | quote }}
            {{- end }}

            # Auth Configuration
            {{- if eq .Values.auth.provider "oidc" }}
            - name: API_AUTH_PROVIDER
              value: "oidc"
            - name: OIDC_ISSUER_URL
              value: {{ .Values.auth.oidc.issuerUrl | quote }}
            - name: OIDC_CLIENT_ID
              value: {{ .Values.auth.oidc.clientId | quote }}
            {{- end }}

            # Zone Settings
            {{- if .Values.dynamicZonesAPI.zoneDefaults.defaultRecords }}
            - name: ZONE_DEFAULTS_ADMIN_RECORDS
              value: {{ .Values.dynamicZonesAPI.zoneDefaults.defaultRecords | quote }}
            {{- end }}

            {{- if .Values.dynamicZonesAPI.zoneDefaults.defaultAdminTsigName }}
            - name: ZONE_DEFAULTS_ADMIN_TSIG_NAME
              value: {{ .Values.dynamicZonesAPI.zoneDefaults.defaultAdminTsigKeyName | quote }}
            - name: ZONE_DEFAULTS_ADMIN_TSIG_KEY
              value: {{ .Values.dynamicZonesAPI.zoneDefaults.defaultAdminTsigKey | quote }}
            - name: ZONE_DEFAULTS_ADMIN_TSIG_ALG
              value: {{ .Values.dynamicZonesAPI.zoneDefaults.defaultAdminTsigAlg | quote }}
            {{- end }}

            # Database Connection
            - name: DB_TYPE
              value: {{ .Values.dynamicZonesAPI.database.type | quote }}
            - name: DB_CONNECTION_STRING
              value: {{ default $defaultConn .Values.dynamicZonesAPI.database.connectionString | quote }}

            # PowerDNS Integration
            - name: PDNS_URL
              value: {{ printf "http://%s:8080" $pdnsSvcName | quote }}
            - name: PDNS_VHOST
              value: {{ .Values.powerDNS.vhost | quote }}
            - name: PDNS_API_KEY
              value: {{ .Values.powerDNS.apiKey | trim | quote }}
            - name: PDNS_SERVER_ADDRESS
              value: {{ .Values.powerDNS.server.ip | quote }}
            - name: PDNS_SERVER_PORT
              value: {{ .Values.powerDNS.server.port | quote }}
            - name: PDNS_SERVER_DEFAULT_TTL
              value: "60"


            # Upstream DNS
            {{- if .Values.dynamicZonesAPI.upstreamDNS.server }}
            - name: UPSTREAM_DNS_SERVER
              value: {{ .Values.dynamicZonesAPI.upstreamDNS.server | quote }}
            - name: UPSTREAM_DNS_PORT
              value: {{ .Values.dynamicZonesAPI.upstreamDNS.port | default "53" | quote }}
            - name: UPSTREAM_DNS_ZONE
              value: {{ .Values.dynamicZonesAPI.upstreamDNS.zone | quote }}
            - name: UPSTREAM_DNS_NAME
              value: {{ .Values.dynamicZonesAPI.upstreamDNS.name | quote }}
            {{- end }}



---
{{- if ne .Values.dynamicZonesAPI.initialDataProviderScript "" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $initialDataScriptName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
data:
  initial-data-script.js: |
    {{ .Values.dynamicZonesAPI.initialDataProviderScript | indent 4 }}
---
{{- end }}

apiVersion: v1
kind: Service
metadata:
  name: {{ $name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
spec:
  selector:
    {{- $selectors | nindent 4 }}
  ports:
    - protocol: TCP
      port: 8082
      targetPort: 8082

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $name }}
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- range $key, $value := .Values.ingress.annotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  rules:
    - host: {{ .Values.dynamicZonesAPI.hostname | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $name }}
                port:
                  number: 8082
  tls:
    - hosts:
        - {{ .Values.dynamicZonesAPI.hostname | quote }}
      secretName: {{ $tlsSecretName }}
